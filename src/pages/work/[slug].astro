---
import PageLayout from '../../layouts/PageLayout.astro';
import { db } from '../../lib/firebase';
import { collection, getDocs, query, orderBy } from 'firebase/firestore';

// This function now also figures out the next and previous projects for navigation
export async function getStaticPaths() {
  // Fetch all projects, sorting by year
  const q = query(collection(db, "case_studies"), orderBy("year", "desc"));
  const querySnapshot = await getDocs(q);
  const projects = querySnapshot.docs.map(doc => doc.data());
  
  const paths = projects.map((project, index) => {
    const prevProject = index > 0 ? projects[index - 1] : null;
    const nextProject = index < projects.length - 1 ? projects[index + 1] : null;
    
    return {
      params: { slug: project.slug },
      props: { 
        project,
        // Pass the full details for the prev/next project cards
        prevProject: prevProject ? { slug: prevProject.slug, name: prevProject.name, heroImage: prevProject.heroImage } : null,
        nextProject: nextProject ? { slug: nextProject.slug, name: nextProject.name, heroImage: nextProject.heroImage } : null,
      },
    };
  });

  return paths;
}

const { project, prevProject, nextProject } = Astro.props;

if (!project) {
  return new Response('Project data could not be loaded.', { status: 500 });
}
---
<PageLayout title={`${project.name} – AniDesignIt`}>
  <!-- Page Header -->
  <div class="text-center mb-12 animate-fade-in-up">
    <h1 class="text-4xl md:text-6xl font-bold tracking-tight" style="font-family: var(--title-font);">
      {project.name}
    </h1>
    <p class="text-lg md:text-xl mt-4 max-w-2xl mx-auto text-gray-600">
      {project.subtitle}
    </p>
  </div>

  <!-- Hero Image -->
  {project.heroImage && (
    <section class="mb-16 md:mb-24 animate-fade-in-up" style="animation-delay: 0.2s;">
      <div class="rounded-2xl shadow-2xl overflow-hidden group">
        <img src={project.heroImage} alt={project.name} class="w-full h-auto object-cover transition-transform duration-500 group-hover:scale-105" />
      </div>
    </section>
  )}

  <!-- Project Details & Body Content -->
  <section class="grid md:grid-cols-3 gap-12">
    <!-- Main Content Body in a White Box -->
    <div class="md:col-span-2 bg-white p-8 md:p-12 rounded-2xl shadow-lg animate-section" data-animation="fade-in-up">
      <div class="prose prose-lg max-w-none" set:html={project.body} />
    </div>

    <!-- Sidebar with Key Info -->
    <aside class="md:col-span-1 space-y-8 animate-section" data-animation="fade-in-up" style="animation-delay: 0.3s;">
      <!-- Live Project Button -->
      {project.urlWeb && (
        <a href={project.urlWeb} target="_blank" rel="noopener noreferrer" class="live-project-btn group">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          <span>View Live Project</span>
        </a>
      )}

      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
        <h3 class="section-title">Project Info</h3>
        <dl class="mt-4 space-y-4 text-gray-800">
          <div><dt class="font-semibold">Client</dt><dd class="mt-1">{project.client}</dd></div>
          <div><dt class="font-semibold">Year</dt><dd class="mt-1">{project.year}</dd></div>
          <div><dt class="font-semibold">My Role</dt><dd class="mt-1">{project.role}</dd></div>
        </dl>
      </div>
      
      {project.tools && project.tools.length > 0 && (
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
          <h3 class="section-title">Tools Used</h3>
          <div class="flex flex-wrap gap-2 mt-4">
            {project.tools.map((tool: string) => (
              <span class="text-sm font-semibold px-4 py-1 rounded-full" style="background-color:#ffe5e0; color:#ff715d">{tool}</span>
            ))}
          </div>
        </div>
      )}
    </aside>
  </section>

  <!-- Gallery Section -->
  {project.gallery && project.gallery.length > 0 && (
    <section class="mt-16 md:mt-24 animate-section" data-animation="fade-in-up">
      <h2 class="gallery-title">Visuals & Mockups</h2>
      <div id="gallery-carousel" class="gallery-carousel-container relative">
        <img id="main-gallery-image" src={project.gallery[0]} alt="Main project visual" class="main-gallery-image rounded-2xl shadow-xl w-full" />
        <div class="gallery-thumbnails mt-4">
          {project.gallery.map((image: string, index: number) => (
            <img src={image} alt={`Thumbnail ${index + 1}`} class:list={["thumbnail-item", { active: index === 0 }]} data-index={index} />
          ))}
        </div>
        <button id="prev-btn" class="gallery-nav-btn left-4">&lt;</button>
        <button id="next-btn" class="gallery-nav-btn right-4">&gt;</button>
      </div>
    </section>
  )}

  <!-- Project Navigation -->
  <section class="mt-24 border-t border-gray-200 pt-12 grid grid-cols-1 md:grid-cols-2 gap-8">
    {prevProject ? (
      <a href={`/work/${prevProject.slug}`} class="nav-card group"><img src={prevProject.heroImage} alt={prevProject.name} class="nav-card-img" /><div class="nav-card-text"><span class="text-sm text-gray-500">← Previous Project</span><h4 class="text-lg font-bold group-hover:text-[#ff715d] transition-colors">{prevProject.name}</h4></div></a>
    ) : <div />}
    {nextProject ? (
      <a href={`/work/${nextProject.slug}`} class="nav-card group md:justify-self-end"><div class="nav-card-text text-right"><span class="text-sm text-gray-500">Next Project →</span><h4 class="text-lg font-bold group-hover:text-[#ff715d] transition-colors">{nextProject.name}</h4></div><img src={nextProject.heroImage} alt={nextProject.name} class="nav-card-img" /></a>
    ) : <div />}
  </section>

  <!-- Image Lightbox Modal -->
  <div id="lightbox" class="lightbox-overlay">
    <span class="lightbox-close">&times;</span>
    <img class="lightbox-content" id="lightbox-img">
  </div>
</PageLayout>

<style is:global>
  /* --- NEW BODY STYLES --- */
  .prose h1 { 
    font-size: 1.875rem !important; /* 30px - A more refined size */
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: var(--title-font); 
    color: var(--secondary-color); 
    letter-spacing: -0.025em;
    margin-bottom: 1rem !important;
  }
  .prose h1 .h1-icon {
    color: var(--primary-color);
    flex-shrink: 0;
  }
  .prose h2, .prose h3, .prose h4 { font-family: var(--title-font); color: var(--secondary-color); letter-spacing: -0.025em; }
  .prose p { color: #555; line-height: 1.7; }
  .prose a { color: var(--primary-color); font-weight: 600; text-decoration: none; transition: opacity 0.2s ease; }
  .prose a:hover { opacity: 0.8; text-decoration: underline; }
  .prose blockquote { border-left-color: var(--primary-color); color: #444; }

  /* --- SIDEBAR & BUTTON STYLES --- */
  .section-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .05em;
    color: var(--primary-color);
    margin-bottom: 1rem;
  }
  .live-project-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.75rem 1rem;
    background-color: var(--primary-color);
    color: white;
    font-weight: 600;
    border-radius: 0.75rem;
    text-decoration: none;
    transition: all 0.3s ease;
  }
  .live-project-btn:hover {
    background-color: #e35c4a;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(255, 114, 94, 0.4);
  }
  
  .nav-card { display: flex; align-items: center; gap: 1rem; background-color: white; padding: 1rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: all 0.3s ease; text-decoration: none; color: inherit; }
  .nav-card:hover { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transform: translateY(-4px); }
  .nav-card-img { width: 80px; height: 60px; object-fit: cover; border-radius: 0.5rem; flex-shrink: 0; }
  .nav-card-text { flex-grow: 1; }

  /* --- GALLERY STYLES --- */
  .gallery-title {
    display: flex; align-items: center; justify-content: center; gap: 0.75rem;
    font-size: 2.25rem; font-weight: 700; font-family: var(--title-font);
    color: var(--primary-color); margin-bottom: 2rem;
  }
  .main-gallery-image { aspect-ratio: 16 / 9; object-fit: cover; transition: opacity 0.3s ease; cursor: zoom-in; }
  .gallery-thumbnails { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
  .thumbnail-item { width: 100px; height: 65px; object-fit: cover; border-radius: 0.5rem; cursor: pointer; border: 3px solid transparent; transition: all 0.3s ease; opacity: 0.6; }
  .thumbnail-item:hover { opacity: 1; transform: scale(1.05); }
  .thumbnail-item.active { opacity: 1; border-color: var(--primary-color); }
  .gallery-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary-color); box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: all 0.2s ease; }
  .gallery-nav-btn:hover { background-color: white; transform: translateY(-50%) scale(1.1); }

  /* Lightbox Styles */
  .lightbox-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
  .lightbox-overlay.show { display: flex; opacity: 1; }
  .lightbox-content { max-width: 90vw; max-height: 85vh; transform: scale(0.8); transition: transform 0.3s ease; }
  .lightbox-overlay.show .lightbox-content { transform: scale(1); }
  .lightbox-close { position: absolute; top: 20px; right: 30px; font-size: 40px; color: white; cursor: pointer; }

  /* Animations */
  .animate-fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; }
  .animate-section { opacity: 0; transform: translateY(30px); transition: opacity 0.8s ease-out, transform 0.8s ease-out; }
  .animate-section.is-visible { opacity: 1; transform: translateY(0); }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Scroll animations
    const sections = document.querySelectorAll(".animate-section");
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add("is-visible");
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1 });
    sections.forEach(sec => observer.observe(sec));

    // Gallery Carousel Logic
    const gallery = document.getElementById('gallery-carousel');
    if (gallery) {
      const mainImage = document.getElementById('main-gallery-image') as HTMLImageElement | null;
      const thumbnails = document.querySelectorAll('.thumbnail-item');
      const prevBtn = document.getElementById('prev-btn') as HTMLElement | null;
      const nextBtn = document.getElementById('next-btn') as HTMLElement | null;
      let currentIndex = 0;

      function showImage(index: number) {
        if (!thumbnails[index] || !mainImage) return;
        mainImage.style.opacity = '0';
        setTimeout(() => {
          mainImage.src = (thumbnails[index] as HTMLImageElement).src;
          mainImage.style.opacity = '1';
        }, 300);
        
        thumbnails.forEach(thumb => thumb.classList.remove('active'));
        thumbnails[index].classList.add('active');
        currentIndex = index;
      }

      thumbnails.forEach((thumb, index) => {
        thumb.addEventListener('click', () => {
          const thumbElement = thumb as HTMLElement;
          showImage(parseInt(thumbElement.dataset.index || '0'));
        });
      });

      if(prevBtn) {
        prevBtn.addEventListener('click', () => {
          const newIndex = (currentIndex - 1 + thumbnails.length) % thumbnails.length;
          showImage(newIndex);
        });
      }

      if(nextBtn) {
        nextBtn.addEventListener('click', () => {
          const newIndex = (currentIndex + 1) % thumbnails.length;
          showImage(newIndex);
        });
      }
    }

    // --- NEW: Add SPECIFIC Icons to Body H1 tags ---
    const proseContainer = document.querySelector('.prose');
    if (proseContainer) {
      const iconMap: { [key: string]: string } = {
        'challenge': `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h1-icon"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`,
        'solution': `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h1-icon"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>`,
        'results': `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h1-icon"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`,
        'testimonial': `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h1-icon"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
      };

      const h1s = proseContainer.querySelectorAll('h1');
      h1s.forEach(h1 => {
        const titleText = h1.textContent?.toLowerCase() || '';
        for (const key in iconMap) {
          if (titleText.includes(key)) {
            h1.insertAdjacentHTML('afterbegin', iconMap[key]);
            break;
          }
        }
      });
    }

    // Image Lightbox Logic
    const lightbox = document.getElementById('lightbox') as HTMLElement | null;
    const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement | null;
    const galleryImages = document.querySelectorAll('#main-gallery-image, .thumbnail-item');
    
    galleryImages.forEach(img => {
      const imgElement = img as HTMLElement;
      imgElement.style.cursor = 'zoom-in';
      imgElement.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent the main image click from bubbling
        if (lightbox && lightboxImg) {
          lightbox.classList.add('show');
          lightboxImg.src = (img as HTMLImageElement).src;
        }
      });
    });

    const closeBtn = document.querySelector('.lightbox-close');
    if (closeBtn && lightbox) {
      closeBtn.addEventListener('click', () => lightbox.classList.remove('show'));
    }
    if (lightbox) {
      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) lightbox.classList.remove('show');
      });
    }
  });
</script>

