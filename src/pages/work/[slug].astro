---
import PageLayout from '../../layouts/PageLayout.astro';
import { db } from '../../lib/firebase';
import { collection, getDocs, query, orderBy } from 'firebase/firestore';

// 1. IMPORT 'marked'
import { marked } from 'marked';

// This function now also figures out the next and previous projects for navigation
export async function getStaticPaths() {
  // Fetch all projects, sorting by year
  const q = query(collection(db, "case_studies"), orderBy("year", "desc"));
  const querySnapshot = await getDocs(q);
  const projects = querySnapshot.docs.map(doc => doc.data());
  
  const paths = projects.map((project, index) => {
    const prevProject = index > 0 ? projects[index - 1] : null;
    const nextProject = index < projects.length - 1 ? projects[index + 1] : null;
    
    return {
      params: { slug: project.slug },
      props: { 
        project,
        // Pass the full details for the prev/next project cards
        prevProject: prevProject ? { slug: prevProject.slug, name: prevProject.name, heroImage: prevProject.heroImage } : null,
        nextProject: nextProject ? { slug: nextProject.slug, name: nextProject.name, heroImage: nextProject.heroImage } : null,
      },
    };
  });

  return paths;
}

const { project, prevProject, nextProject } = Astro.props;

if (!project) {
  return new Response('Project data could not be loaded.', { status: 500 });
}

// 2. PARSE THE MARKDOWN *AFTER* 'project' IS DEFINED
const renderedBodyHtml = project.body ? marked.parse(project.body) : '';
---
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>My Portfolio</title>
    
    <script 
      src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" 
      type="module"
    ></script>

    </head>
  <body>
    <slot /> 
  </body>
</html>
<PageLayout title={`${project.name} ‚Äì AniDesignIt`}>
  <!-- Page Header -->
  <div class="text-center mb-12 animate-fade-in-up">
    <h1 class="text-4xl md:text-6xl font-bold tracking-tight" style="font-family: var(--title-font);">
      {project.name}
    </h1>
    <h4 class="text-sx1 md:text-xl mt-4 max-w-2xl mx-auto text-color:  #e35c4a;">
      {project.subtitle}
    </h4>
  </div>

  <!-- Hero Image -->
  {project.heroImage && (
    <section class="mb-16 md:mb-24 animate-fade-in-up" style="animation-delay: 0.2s;">
      <div class="rounded-2xl shadow-2xl overflow-hidden group">
        <img src={project.heroImage} alt={project.name} class="w-full h-auto object-cover transition-transform duration-500 group-hover:scale-105" />
      </div>
    </section>
  )}

  <!-- Project Overview & Metadata Section -->
  <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-16 md:mb-24">
    <!-- Left Column: Project Overview -->
    <div class="lg:col-span-2 bg-white p-8 md:p-12 rounded-2xl shadow-lg animate-section" data-animation="fade-in-up" style="animation-delay: 0.3s;">
      <h2 class="body-summary-title">Overview</h2>
      {project.summaryLong && (
        <p class="text-base mb-6 text-gray-600 letter-spacing-widest">
          {project.summaryLong}
        </p>
      )}
      {project.urlWeb && (
        <div>
           <a href={project.urlWeb} target="_blank" rel="noopener noreferrer" class="live-project-btn inline-flex group">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
            <span>View Live Project</span>
          </a>
        </div>
      )}
    </div>

    <!-- Right Column: Metadata -->
    <div class="bg-white p-8 rounded-2xl shadow-lg animate-section" data-animation="fade-in-up" style="animation-delay: 0.4s;">
        <div class="space-y-6">
            <div>
              <h3 class="meta-title">Client</h3>
              <p class="meta-content">{project.client}</p>
            </div>
            <div>
              <h3 class="meta-title">Year</h3>
              <p class="meta-content">{project.year}</p>
            </div>
            <div>
              <h3 class="meta-title">Role</h3>
              <p class="meta-content">{project.role}</p>
            </div>
            {project.tools && project.tools.length > 0 && (
              <div>
                <h3 class="meta-title">Tools</h3>
                <p class="meta-content">{project.tools.join(', ')}</p>
              </div>
            )}
        </div>
    </div>
  </section>

  <!-- Main Content Body -->
  <section class="mb-16 md:mb-24">
    <div class="bg-white p-8 md:p-12 rounded-2xl shadow-lg animate-section w-full" data-animation="fade-in-up" style="animation-delay: 0.4s;">
      <!-- <h2 class="body-summary-title">The Project</h2> -->
      <!-- 3. USE THE 'renderedBodyHtml' VARIABLE HERE -->
      <div class="prose prose-lg max-w-none" set:html={renderedBodyHtml} />
    </div>
  </section>

  <!-- Gallery Section -->
  {project.gallery && project.gallery.length > 0 && (
    <section class="mt-16 md:mt-24 animate-section" data-animation="fade-in-up">
      {/* <h2 class="gallery-title">Gallery</h2> */}
      <div class="gallery-stack">
        {project.gallery.map((image: string, index: number) => (
          <img 
            src={image} 
            alt={`Gallery image ${index + 1}`} 
            class="gallery-stack-item"
            loading="lazy"
          />
        ))}
      </div>
    </section>
  )}

  <!-- Project Navigation -->
  <section class="mt-24 border-t border-gray-200 pt-12 grid grid-cols-1 md:grid-cols-2 gap-8">
    {prevProject ? (
      <a href={`/work/${prevProject.slug}`} class="nav-card group"><img src={prevProject.heroImage} alt={prevProject.name} class="nav-card-img" /><div class="nav-card-text"><span class="text-sm text-gray-500">‚Üê Previous Project</span><h4 class="text-lg font-bold group-hover:text-[#ff715d] transition-colors">{prevProject.name}</h4></div></a>
    ) : <div />}
    {nextProject ? (
      <a href={`/work/${nextProject.slug}`} class="nav-card group md:justify-self-end"><div class="nav-card-text text-right"><span class="text-sm text-gray-500">Next Project ‚Üí</span><h4 class="text-lg font-bold group-hover:text-[#ff715d] transition-colors">{nextProject.name}</h4></div><img src={nextProject.heroImage} alt={nextProject.name} class="nav-card-img" /></a>
    ) : <div />}
  </section>

  <!-- Image Lightbox Modal -->
  <div id="lightbox" class="lightbox-overlay">
    <span class="lightbox-close">&times;</span>
    <img class="lightbox-content" id="lightbox-img">
  </div>
</PageLayout>

<style is:global>
  /* --- NEW BODY STYLES --- */

  /* üå∏ Basic heading styling for AniDesignIt aesthetic */

h1, h2, h3 {
  font-family: "Literata", serif;
  color: #3f4142;
  line-height: 1.5;
  margin-top: 2 rem;
  margin-bottom: 0.5
  rem;
  letter-spacing: 0.5px;
}

/* H1 ‚Äî big, elegant title */
h1 {
  font-size: 2rem;
  color: #3f4142;
  font-weight: 700;
}

/* H2 ‚Äî section headers */
h2 {
  font-size: 2rem;
  margin-top: 2rem;
  margin-bottom: 1rem;
  font-weight: 600;
  color: #ff8a70;
}

/* H3 ‚Äî subheaders */
h3 {
  font-size: 1.5rem;
  font-weight: 500;
  color: #555;
}

/* Optional: smooth spacing between paragraphs */
p {
  margin-bottom: 1rem;
  font-family: "Open Sans", sans-serif;
  color: #3f4142;
  line-height: 1.7rem;
}

hr{
  margin-top: 3rem;
}

/* Restore proper bullet rendering */
ul, ol {
  list-style: disc outside;
  margin: 1rem 0 1.5rem 1.5rem;
  padding: 0;
}

/* Ensure bullets actually display even if CMS resets them */
ul li, ol li {
  display: list-item !important;
}

/* AniDesignIt accent color for bullets */
li::marker {
  color: #ff725e;
  font-size: 1.1em;
}

/* Optional: improve line height */
li {
  line-height: 1.6;
  margin-bottom: 0.4rem;
}

  .prose h1 { 
    font-size: 1.875rem !important; /* 30px - A more refined size */
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-family: var(--title-font); 
    color: var(--secondary-color); 
    letter-spacing: -0.025em;
    margin-bottom: 1rem !important;
  }
  .prose h1 .h1-icon {
    color: var(--primary-color);
    flex-shrink: 0;
  }

  .prose h2, .prose h3, .prose h4 { font-family: var(--title-font); color: var(--secondary-color); letter-spacing: -0.025em; }
  .prose p { color: #555; line-height: 1.7; }
  .prose a { color: var(--primary-color); font-weight: 600; text-decoration: none; transition: opacity 0.2s ease; }
  .prose a:hover { opacity: 0.8; text-decoration: underline; }
  .prose blockquote { border-left-color: var(--primary-color); color: #444; }



  /* --- METADATA STYLES --- */
  .meta-title {
    font-size: 1rem; /* 12px */
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .05em;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
  }
  .meta-content {
    font-size: 1rem;
    color: var(--secondary-color);
  }

  /* --- BODY SUMMARY TITLE --- */
  .body-summary-title {
    font-size: 2rem; /* 24px */
    font-weight: 700;
    font-family: var(--title-font);
    color: var(--secondary-color);
    margin-bottom: 1.5rem;
    margin-top: 0rem;
    text-align: left;
  }

  /* --- SIDEBAR & BUTTON STYLES --- */
  .section-title {
    font-size: 2rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: .05em;
    color: var(--secondary-color);
    margin-bottom: 1rem;
    font-family: var(--title-font);
  }
  .live-project-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background-color: var(--primary-color);
    color: white;
    font-weight: 600;
    border-radius: 0.75rem;
    text-decoration: none;
    transition: all 0.3s ease;
  }
  .live-project-btn:hover {
    background-color: #e35c4a;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(255, 114, 94, 0.4);
  }
  
  .nav-card { display: flex; align-items: center; gap: 1rem; background-color: white; padding: 1rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: all 0.3s ease; text-decoration: none; color: inherit; }
  .nav-card:hover { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transform: translateY(-4px); }
  .nav-card-img { width: 80px; height: 60px; object-fit: cover; border-radius: 0.5rem; flex-shrink: 0; }
  .nav-card-text { flex-grow: 1; }

  /* --- GALLERY STYLES (UPDATED) --- */
  .gallery-title {
    display: flex; align-items: center; justify-content: center; gap: 0.75rem;
    font-size: 2.25rem; font-weight: 700; font-family: var(--title-font);
    color: var(--primary-color); margin-bottom: 2rem;
  }
  .gallery-stack {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2rem;
  }
  .gallery-stack-item {
    width: 100%;
    max-width: 1200px;
    height: auto;
    border-radius: 1rem;
    transition: transform 0.3s ease;
    cursor: zoom-in;
  }
  .gallery-stack-item:hover {
    transform: scale(1.01);
  }

  #zolu-project-description ul {
    list-style-type: disc;
    list-style-position: outside;
    margin-left: 20px; /* Adjust this value as needed */
  }

  /* This is the responsive video embed style */
  .video-container {
    position: relative;
    width: 100%;
    max-width: 960px;
    margin: 0 auto 24px;
    padding-top: 56.25%; /* 16:9 Aspect Ratio */
  }
  
  .video-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0;
  }

  /* ‚ú® NEWLY ADDED ‚ú®
    This adds a small space (8px) below each bullet point
    to prevent them from being too close together.
  */
  #zolu-project-description li {
    margin-bottom: 8px; /* Adjust this 8px value as needed */
  }
  

  /* Lightbox Styles */
  .lightbox-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
  .lightbox-overlay.show { display: flex; opacity: 1; }
  .lightbox-content { max-width: 90vw; max-height: 85vh; transform: scale(0.8); transition: transform 0.3s ease; }
  .lightbox-overlay.show .lightbox-content { transform: scale(1); }
  .lightbox-close { position: absolute; top: 20px; right: 30px; font-size: 40px; color: white; cursor: pointer; }

  /* Animations */
  .animate-fade-in-up { animation: fadeInUp 0.8s ease-out forwards; opacity: 0; }
  .animate-section { opacity: 0; transform: translateY(30px); transition: opacity 0.8s ease-out, transform 0.8s ease-out; }
  .animate-section.is-visible { opacity: 1; transform: translateY(0); }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Scroll animations
    const sections = document.querySelectorAll(".animate-section");
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add("is-visible");
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.1 });
    sections.forEach(sec => observer.observe(sec));

    // --- NEW: Add SPECIFIC Icons to Body H1 tags ---
    const proseContainer = document.querySelector('.prose');
    if (proseContainer) {
      const iconMap: { [key: string]: string } = {
        'challenge': `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h1-icon"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`,
        'solution': `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h1-icon"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>`,
        'results': `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h1-icon"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`,
        'testimonial': `<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h1-icon"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
      };

      const h1s = proseContainer.querySelectorAll('h1');
      h1s.forEach(h1 => {
        const titleText = h1.textContent?.toLowerCase() || '';
        for (const key in iconMap) {
          if (titleText.includes(key)) {
            h1.insertAdjacentHTML('afterbegin', iconMap[key]);
            break;
          }
        }
      });
    }

    // Image Lightbox Logic (UPDATED)
    const lightbox = document.getElementById('lightbox') as HTMLElement | null;
    const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement | null;
    const galleryImages = document.querySelectorAll('.gallery-stack-item');
    
    galleryImages.forEach(img => {
      img.addEventListener('click', () => {
        if (lightbox && lightboxImg) {
          lightbox.classList.add('show');
          lightboxImg.src = (img as HTMLImageElement).src;
        }
      });
    });

    const closeBtn = document.querySelector('.lightbox-close');
    if (closeBtn && lightbox) {
      closeBtn.addEventListener('click', () => lightbox.classList.remove('show'));
    }
    if (lightbox) {
      lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) lightbox.classList.remove('show');
      });
    }
  });
</script>

