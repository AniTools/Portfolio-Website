---
// Import the Project Card component
import ProjectCard from "./ProjectCard.astro";
// Import the necessary Firebase functions
import { db } from "../lib/firebase"; // Make sure the path is correct
import { collection, getDocs } from "firebase/firestore";

let projects: any[] = [];

try {
  // This block is now updated for Firestore
  console.log("Fetching projects from Firestore...");
  const querySnapshot = await getDocs(collection(db, "case_studies"));
  
  // We map the Firestore documents to a clean array of project objects
  projects = querySnapshot.docs.map(doc => doc.data());

  console.log(`Successfully fetched ${projects.length} projects.`);

} catch (e) {
  // The error handling remains the same
  console.error("Error loading projects from Firestore:", e);
}
---

<section id="my-work" class="section relative">
  <h2 class="section-title">My Work</h2>

  <div class="relative w-full max-w-6xl mx-auto">
    <div
      id="carousel"
      class="flex overflow-x-auto scroll-smooth snap-x snap-mandatory no-scrollbar"
    >
      {projects.map((project) => (
        <div class="flex-shrink-0 w-full sm:w-1/2 lg:w-1/3 snap-center px-4">
          <ProjectCard project={project} />
        </div>
      ))}
    </div>

    <div id="dots" class="flex justify-center mt-6 gap-2"></div>
  </div>
 
</section>

<!-- The style and script sections are perfect and do not need any changes -->
<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>

<script>
  const carousel = document.getElementById("carousel") as HTMLElement | null;
  const dotsContainer = document.getElementById("dots") as HTMLElement | null;

  if (carousel && dotsContainer) {
    const cards = carousel.children.length;
    let index = 0;
    let canScroll = true; // âœ… scoped variable

    // Create dots
    for (let i: number = 0; i < cards; i++) {
      const dot = document.createElement("span");
      dot.className =
        "w-3 h-3 rounded-full bg-gray-300 inline-block cursor-pointer transition";
      dot.dataset.index = i.toString();
      dotsContainer.appendChild(dot);
    }

    function updateDots() {
      dotsContainer?.querySelectorAll("span").forEach((dot, i) => {
        if (dot instanceof HTMLElement) {
          dot.className =
            "w-3 h-3 rounded-full inline-block cursor-pointer transition " +
            (i === index ? "bg-[#ff715d]" : "bg-gray-300");
        }
      });
    }

    function scrollToIndex(i: number) {
      const card = carousel?.children[i] as HTMLElement | undefined;
      if (card) {
        carousel?.scrollTo({ left: card.offsetLeft, behavior: "smooth" });
        index = i;
        updateDots();
      }
    }

    // Dots click
    dotsContainer.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      if (target?.dataset.index) {
        index = parseInt(target.dataset.index);
        scrollToIndex(index);
      }
    });

    // Autoplay
    setInterval(() => {
      index = (index + 1) % cards;
      scrollToIndex(index);
    }, 5000);

    updateDots();
  }
</script>
